<div id="archive-component-wrapper" class="archive-component-scope">
    <style>
        /* --- CSS Scoping cho Archive --- */
        .archive-component-scope {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            width: 100%;
            display: block;
            padding-bottom: 50px;
        }

        .archive-component-scope * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        .archive-component-scope .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .archive-component-scope .archive-header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .archive-component-scope .archive-header h1 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .archive-component-scope .search-section {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 15px;
            margin: 20px 0;
        }

        .archive-component-scope .search-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
        }

        .archive-component-scope select.search-input {
            cursor: pointer;
        }

        .archive-component-scope .search-button {
            padding: 10px 20px;
            background: #0070c0;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            white-space: nowrap;
        }

        .archive-component-scope .search-button:hover {
            background: #0056b3;
        }

        .archive-component-scope .articles-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .archive-component-scope .article-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            display: flex;
            flex-direction: column;
        }

        .archive-component-scope .article-card:hover {
            transform: translateY(-5px);
        }

        .archive-component-scope .article-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .archive-component-scope .article-content {
            padding: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .archive-component-scope .article-category {
            display: inline-block;
            padding: 3px 10px;
            background: #0070c0;
            color: white;
            border-radius: 15px;
            font-size: 0.8em;
            margin-bottom: 10px;
            align-self: flex-start;
        }

        .archive-component-scope .article-title {
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #333;
            text-decoration: none;
            font-weight: bold;
            display: block;
        }

        .archive-component-scope .article-title:hover {
            color: #0070c0;
        }

        .archive-component-scope .article-meta {
            font-size: 0.9em;
            color: #666;
            margin-top: auto;
        }

        /* Pagination Styles */
        .archive-component-scope .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 20px 0;
        }

        .archive-component-scope .page-button {
            padding: 8px 15px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .archive-component-scope .page-button.active {
            background: #0070c0;
            color: white;
            border-color: #0070c0;
        }

        .archive-component-scope .page-button:disabled {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }

        .archive-component-scope .no-results {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .archive-component-scope .articles-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .archive-component-scope .search-section {
                grid-template-columns: 1fr 1fr;
            }
            .archive-component-scope .search-section input {
                grid-column: span 2;
            }
            .archive-component-scope .search-section button {
                grid-column: span 2;
            }
        }

        @media (max-width: 600px) {
            .archive-component-scope .articles-grid {
                grid-template-columns: 1fr;
            }
            .archive-component-scope .search-section {
                grid-template-columns: 1fr;
            }
            .archive-component-scope .search-section > * {
                grid-column: span 1 !important;
            }
        }
    </style>

    <div class="container">
        <div class="archive-header">
            <h1>Kho Lưu Trữ Tin Tức Y Khoa</h1>
            
            <div class="search-section">
                <input type="text" 
                       class="search-input" 
                       id="searchInput" 
                       placeholder="Tìm kiếm tin tức...">
                
                <select class="search-input" id="departmentFilter">
                    <option value="">Tất cả chuyên khoa</option>
                    <option value="Obstetrics_and_Gynecology">Sản Phụ Khoa</option>
                    <option value="ENT">Tai Mũi Họng</option>
                    <option value="Internal_Medicine">Nội Khoa</option>
                    <option value="Musculoskeletal_System">Khoa Cơ Xương Khớp</option>                
                </select>

                <select class="search-input" id="sortBy">
                    <option value="newest">Mới nhất trước</option>
                    <option value="oldest">Cũ nhất trước</option>
                </select>

                <button class="search-button" id="btnApplyFilters">
                    Tìm Kiếm
                </button>
            </div>
        </div>

        <div class="articles-grid" id="articlesContainer">
            <div style="grid-column: 1/-1; text-align: center; padding: 20px;">Đang tải dữ liệu...</div>
        </div>

        <div class="pagination" id="pagination"></div>
    </div>

    <script>
        (function() {
            // --- SCOPE VARIABLES ---
            const wrapper = document.querySelector('#archive-component-wrapper');
            let currentPage = 1;
            const itemsPerPage = 9;
            
            let currentFilteredList = []; 
            let departmentsData = [];
            let allArticles = [];

            // --- DỮ LIỆU CẤU HÌNH ---
            // Giữ lại map tên chuyên khoa từ file cũ để hiển thị tiếng Việt đẹp
            const rawDepartmentsJson = '[{"name":"Obstetrics_and_Gynecology","nameVi":"Sản Phụ Khoa"},{"name":"ENT","nameVi":"Tai Mũi Họng"},{"name":"Internal_Medicine","nameVi":"Nội Khoa"},{"name":"Musculoskeletal_System","nameVi":"Khoa Cơ Xương Khớp"}]';
            
            try {
                departmentsData = JSON.parse(rawDepartmentsJson);
            } catch (e) {
                console.error("Lỗi Parse Departments:", e);
            }

            // --- CORE FUNCTIONS ---

            // 1. Fetch Data từ file JSON thay vì biến cứng
            async function fetchArticles() {
                try {
                    // Đường dẫn tương đối từ index.html vào thư mục data
                    const response = await fetch('data/articles.json');
                    if (!response.ok) throw new Error('Không thể tải dữ liệu bài viết');
                    
                    const data = await response.json();
                    
                    if (Array.isArray(data)) {
                        allArticles = data.map(article => ({
                            ...article,
                            date: new Date(article.date) // Convert string date to Object
                        }));
                        
                        // Khởi tạo bộ lọc sau khi có dữ liệu
                        checkUrlParamsAndApply();
                    }
                } catch (error) {
                    console.error("Lỗi fetch:", error);
                    wrapper.querySelector('#articlesContainer').innerHTML = 
                        '<div class="no-results">Lỗi tải dữ liệu. Vui lòng thử lại sau.</div>';
                }
            }

            // 2. Xử lý URL Params (nếu có) và gọi Apply Filter
            function checkUrlParamsAndApply() {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const deptFromUrl = urlParams.get('department');
                    const deptSelect = wrapper.querySelector('#departmentFilter');
                    
                    if (deptFromUrl && deptSelect) {
                        deptSelect.value = deptFromUrl;
                    }
                } catch (e) {
                    console.error("Lỗi đọc URL:", e);
                }
                applyFilters();
            }

            // 3. Logic Lọc (Giữ nguyên logic gốc)
            function applyFilters() {
                const searchInput = wrapper.querySelector('#searchInput');
                const deptSelect = wrapper.querySelector('#departmentFilter');
                const sortSelect = wrapper.querySelector('#sortBy');

                const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                const department = deptSelect ? deptSelect.value : '';
                const sortBy = sortSelect ? sortSelect.value : 'newest';

                currentFilteredList = allArticles.filter(article => {
                    const title = article.title ? article.title.toLowerCase() : '';
                    // Check content nếu có, hoặc bỏ qua để tối ưu
                    const content = article.content ? article.content.toLowerCase() : ''; 
                    
                    const matchesSearch = title.includes(searchTerm) || content.includes(searchTerm);
                    const matchesDepartment = department ? article.department === department : true;
                    return matchesSearch && matchesDepartment;
                });

                // Sort
                currentFilteredList.sort((a, b) => {
                    if (sortBy === 'newest') {
                        return b.date.getTime() - a.date.getTime();
                    } else {
                        return a.date.getTime() - b.date.getTime();
                    }
                });

                currentPage = 1;
                renderPage();
            }

            // 4. Logic Phân trang
            function renderPage() {
                displayArticles(currentFilteredList);
                displayPagination(currentFilteredList.length);
            }

            // 5. Hiển thị bài viết
            function displayArticles(articles) {
                const container = wrapper.querySelector('#articlesContainer');
                const start = (currentPage - 1) * itemsPerPage;
                const paginatedArticles = articles.slice(start, start + itemsPerPage);

                if (paginatedArticles.length === 0) {
                    container.innerHTML = `
                        <div class="no-results">
                            <h3>Không tìm thấy kết quả</h3>
                            <p>Vui lòng thử lại với từ khóa khác</p>
                        </div>
                    `;
                    const pagination = wrapper.querySelector('#pagination');
                    if(pagination) pagination.style.display = 'none';
                    return;
                }

                container.innerHTML = paginatedArticles.map(article => `
                    <div class="article-card">
                        <img src="${article.imageUrl}" alt="${article.title}" class="article-image" loading="lazy">
                        <div class="article-content">
                            <span class="article-category">${getDepartmentName(article.department)}</span>
                            <h3><a href="news/articles/${article.id}/${article.id}.html" class="article-title">${article.title}</a></h3>
                            <div class="article-meta">
                                ${formatDate(article.date)}
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // Scroll nhẹ lên đầu vùng grid
                const headerHeight = document.querySelector('header')?.offsetHeight || 0;
                const containerTop = container.getBoundingClientRect().top + window.pageYOffset - headerHeight - 20;
                // Chỉ scroll nếu container không nằm trong viewport
                // window.scrollTo({top: containerTop, behavior: 'smooth'}); 
            }

            // 6. Hiển thị nút phân trang
            function displayPagination(totalItems) {
                const totalPages = Math.ceil(totalItems / itemsPerPage);
                const pagination = wrapper.querySelector('#pagination');
                
                if (totalPages <= 1) {
                    pagination.style.display = 'none';
                    return;
                }

                pagination.style.display = 'flex';
                let paginationHtml = '';

                // Nút Trước
                paginationHtml += `
                    <button class="page-button prev-btn" 
                            ${currentPage === 1 ? 'disabled' : ''}>
                        ← Trước
                    </button>
                `;

                // Các nút số
                for (let i = 1; i <= totalPages; i++) {
                    // Logic rút gọn trang nếu quá nhiều trang có thể thêm sau
                    paginationHtml += `
                        <button class="page-button page-num-btn ${currentPage === i ? 'active' : ''}"
                                data-page="${i}">
                            ${i}
                        </button>
                    `;
                }

                // Nút Tiếp
                paginationHtml += `
                    <button class="page-button next-btn" 
                            ${currentPage === totalPages ? 'disabled' : ''}>
                        Tiếp →
                    </button>
                `;

                pagination.innerHTML = paginationHtml;

                // Gán sự kiện click cho các nút phân trang
                attachPaginationEvents(totalPages);
            }

            function attachPaginationEvents(totalPages) {
                const prevBtn = wrapper.querySelector('.prev-btn');
                const nextBtn = wrapper.querySelector('.next-btn');
                const numBtns = wrapper.querySelectorAll('.page-num-btn');

                if(prevBtn) prevBtn.onclick = () => changePage(currentPage - 1, totalPages);
                if(nextBtn) nextBtn.onclick = () => changePage(currentPage + 1, totalPages);
                
                numBtns.forEach(btn => {
                    btn.onclick = () => changePage(parseInt(btn.dataset.page), totalPages);
                });
            }

            function changePage(page, totalPages) {
                if (page < 1 || page > totalPages) return;
                currentPage = page;
                renderPage();
            }

            // --- UTILITIES ---
            function getDepartmentName(departmentKey) {
                const dept = departmentsData.find(d => d.name === departmentKey);
                return dept ? dept.nameVi : departmentKey;
            }

            function formatDate(date) {
                return date.toLocaleDateString('vi-VN');
            }

            // --- INITIALIZATION ---
            function initArchiveComponent() {
                // Gán sự kiện cho nút Search
                const searchBtn = wrapper.querySelector('#btnApplyFilters');
                if(searchBtn) {
                    searchBtn.addEventListener('click', applyFilters);
                }

                // Gán sự kiện Enter cho input
                const searchInput = wrapper.querySelector('#searchInput');
                if(searchInput) {
                    searchInput.addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') applyFilters();
                    });
                }

                // Bắt đầu tải dữ liệu
                fetchArticles();
            }

            // Chạy ngay lập tức
            initArchiveComponent();

        })();
    </script>
</div>